version: 2.1
orbs:
  aws-cli: circleci/aws-cli@4.1.3
  terraform: circleci/terraform@3.2.1

commands:
  yarn_install:
    steps:
      - run: corepack enable --install-directory ~/bin
      - restore_cache:
          keys:
            - bt-modules-{{ checksum "yarn.lock" }}
            - bt-modules-
      - run:
          name: Install Dependencies
          command: yarn install
      - save_cache:
          key: bt-modules-{{ checksum "yarn.lock" }}
          paths:
            - node_modules/
            - packages/api/node_modules/
            - packages/common/node_modules/
            - packages/e2e-tests/node_modules/
            - packages/emails/node_modules/
            - packages/service/node_modules/
            - packages/web/node_modules/

  deploy_env:
    parameters:
      state_bucket:
        type: string
        default: 'bottomtime-tfstate'
      state_key:
        type: string
      var_file:
        type: string
    steps:
      - aws-cli/install
      - checkout
      - yarn_install
      - attach_workspace:
          at: ./
      - run:
          name: Migrate Database
          working_directory: packages/service/
          command: yarn migrate:up
      - terraform/install:
          terraform_version: '1.9.1'
      - terraform/init:
          backend_config: 'bucket="<<parameters.state_bucket>>",key="<<parameters.state_key>>",region="$AWS_REGION"'
          path: terraform/
      - terraform/validate:
          path: terraform/
      - terraform/apply:
          var_file: <<parameters.var_file>>
          path: terraform/
      - run:
          name: CloudFront Buckets
          working_directory: terraform/
          command: ./deploy-files.sh

jobs:
  build:
    docker:
      - image: cimg/node:20.14
    resource_class: medium
    steps:
      - checkout
      - yarn_install
      - run:
          name: Download Code Climate coverage tool
          command: |
            curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
            chmod +x ./cc-test-reporter
      - run:
          name: Lint and Build
          command: |
            yarn lint
            yarn build --stream
      - persist_to_workspace:
          root: ./
          paths:
            - .nx/
            - packages/api/dist/
            - packages/common/dist/
            - packages/emails/dist/
            - packages/service/dist/
            - packages/web/dist/
            - cc-test-reporter

  test_packages:
    docker:
      - image: cimg/node:20.14
    resource_class: medium
    environment:
      JEST_JUNIT_OUTPUT_DIR: ./reports/
    steps:
      - checkout
      - yarn_install
      - attach_workspace:
          at: ./
      - run:
          name: Initialize Code Climate
          command: ./cc-test-reporter before-build

      - run:
          name: Run Tests
          command: |
            yarn test --scope=@bottomtime/{api,common,emails} -- --runInBand --ci

      - store_test_results:
          path: packages/api/reports/
      - store_test_results:
          path: packages/common/reports/
      - store_test_results:
          path: packages/emails/reports/

      - run:
          name: Report API coverage
          working_directory: packages/api/
          command: |
            ../../cc-test-reporter format-coverage "coverage/lcov.info" \
              --add-prefix "packages/api/" \
              -t lcov \
              -o "../../api.coverage.json"
      - run:
          name: Report Common Lib coverage
          working_directory: packages/common/
          command: |
            ../../cc-test-reporter format-coverage "coverage/lcov.info" \
              --add-prefix "packages/common/" \
              -t lcov \
              -o "../../common.coverage.json"
      - run:
          name: Report Email Service coverage
          working_directory: packages/emails/
          command: |
            ../../cc-test-reporter format-coverage "coverage/lcov.info" \
              --add-prefix "packages/emails/" \
              -t lcov \
              -o "../../emails.coverage.json"

      - persist_to_workspace:
          root: ./
          paths:
            - packages/api/coverage/
            - api.coverage.json
            - common.coverage.json
            - emails.coverage.json

  test_service:
    docker:
      - image: cimg/node:20.14
      - image: postgis/postgis:14-3.4-alpine
        environment:
          POSTGRES_DB: postgres
          POSTGRES_USER: bt_user
          POSTGRES_PASSWORD: bt_admin1234
      - image: lphoward/fake-s3
    resource_class: medium+
    environment:
      JEST_JUNIT_OUTPUT_DIR: ./reports/
    steps:
      - checkout
      - yarn_install
      - attach_workspace:
          at: ./
      - run:
          name: Initialize Code Climate
          command: ./cc-test-reporter before-build
      - run:
          name: Run Tests
          working_directory: packages/service/
          command: |
            # yarn test --scope=@bottomtime/service --stream -- --ci
            yarn prepare && yarn test --ci
      - store_test_results:
          path: packages/service/reports/
      - run:
          name: Report test coverage
          working_directory: packages/service/
          command: |
            ../../cc-test-reporter format-coverage "coverage/lcov.info" \
              --add-prefix "packages/service/" \
              -t lcov \
              -o "../../service.coverage.json" \
      - persist_to_workspace:
          root: ./
          paths:
            - packages/service/coverage/
            - service.coverage.json

  test_web:
    docker:
      - image: cimg/node:20.14-browsers
    environment:
      JEST_JUNIT_OUTPUT_DIR: ./reports/
      NODE_OPTIONS: '--max-old-space-size=8192'
    steps:
      - checkout
      - yarn_install
      - attach_workspace:
          at: ./
      - run:
          name: Initialize Code Climate
          command: ./cc-test-reporter before-build
      - run:
          name: Run Tests
          command: |
            yarn test --scope=@bottomtime/web --stream -- --runInBand --ci
      - store_test_results:
          path: packages/web/reports/
      - run:
          name: Report test coverage
          working_directory: packages/web/
          command: |
            ../../cc-test-reporter format-coverage "coverage/lcov.info" \
              --add-prefix "packages/web/" \
              -t lcov \
              -o "../../web.coverage.json" \
      - persist_to_workspace:
          root: ./
          paths:
            - packages/web/coverage/
            - web.coverage.json

  test_e2e:
    docker:
      - image: cimg/node:20.14-browsers
    resource_class: medium
    environment:
      BT_POSTGRES_REQUIRE_SSL: 'true'
      JEST_JUNIT_OUTPUT_DIR: ./reports/
    steps:
      - checkout
      - yarn_install
      - attach_workspace:
          at: ./
      - run:
          name: Run end-to-end tests
          working_directory: packages/e2e-tests/
          command: |
            # yarn test --scope=@bottomtime/e2e-tests --stream
            yarn prepare && yarn test
      - store_test_results:
          path: ./packages/e2e-tests/test-results/
      - store_artifacts:
          path: ./packages/e2e-tests/test-results/

  report_coverage:
    docker:
      - image: cimg/node:20.14
    resource_class: medium
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Initialize Code Climate
          command: ./cc-test-reporter before-build
      - run:
          name: Report coverage
          command: |
            ./cc-test-reporter sum-coverage -o codeclimate.json -p 5 *.coverage.json
            ./cc-test-reporter upload-coverage -i codeclimate.json

  deploy_e2e:
    docker:
      - image: cimg/node:20.14
    environment:
      BT_POSTGRES_REQUIRE_SSL: 'true'
    resource_class: medium
    steps:
      - deploy_env:
          state_key: $AWS_REGION.e2e.tfvars
          var_file: vars/e2e.tfvars

  deploy_staging:
    docker:
      - image: cimg/node:20.14
    environment:
      BT_POSTGRES_REQUIRE_SSL: 'true'
    resource_class: medium
    steps:
      - deploy_env:
          state_key: $AWS_REGION.staging.tfvars
          var_file: vars/staging.tfvars

  deploy_production:
    docker:
      - image: cimg/node:20.14
    environment:
      BT_POSTGRES_REQUIRE_SSL: 'true'
    resource_class: medium
    steps:
      - deploy_env:
          state_key: $AWS_REGION.production.tfvars
          var_file: vars/production.tfvars

workflows:
  test_and_deploy:
    jobs:
      # 1) Iniitialize and build
      - build
      - deploy_e2e:
          requires:
            - build
          context:
            - bt-aws-dev
            - bt-postgres-e2e
            - bt-smtp-dev

      # 2) Run tests
      - test_packages:
          requires:
            - build
      - test_service:
          requires:
            - build
          context:
            - bt-aws-dev
            - bt-smtp-dev
      - test_web:
          requires:
            - build
      - test_e2e:
          requires:
            - deploy_e2e
          context:
            - bt-aws-e2e
            - bt-smtp-dev
            - bt-postgres-e2e

      # 3) Report test coverage
      - report_coverage:
          requires:
            - test_packages
            - test_service
            - test_web

      # 4) Deployment (branch dependent)
      - deploy_staging:
          requires:
            - report_coverage
            - test_e2e
          context:
            - bt-aws-dev
            - bt-postgres-staging
            - bt-smtp-dev
          filters:
            branches:
              only:
                - master

      - deploy_production:
          requires:
            - report_coverage
            - test_e2e
          context:
            - bt-aws-dev
            - bt-postgres-prod
            - bt-smtp-dev
          filters:
            branches:
              only:
                - production
