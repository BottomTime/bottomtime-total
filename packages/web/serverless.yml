org: bottomtime
app: bottomtime
service: bottomtime-web

provider:
  name: aws
  runtime: nodejs20.x
  runtimeManagement: auto
  stage: ${env:NODE_ENV, 'dev'}
  region: ${env:AWS_REGION, 'us-east-1'}
  stackName: ${self:service}-${self:provider.stage}
  stackTags:
    org: ${self:org}
    app: ${self:app}
    service: ${self:service}
  httpApi:
    # id: TODO: Get this from Terraform
    payload: '2.0'
    name: ${self:service}-${self:provider.stage}
    cors: true

plugins:
  - serverless-offline

package:
  individually: true

custom:
  secrets: ${ssm(us-east-1):/aws/reference/secretsmanager/${opt:secrets, 'bt-service-dev'}}

functions:
  main:
    name: ${self:service}-${self:provider.stage}-main
    description: Bottomtime front-end Vue application
    handler: dist/sls-entry.handler
    environment:
      BTWEB_APP_TITLE: Bottom Time
      BTWEB_API_URL: 'http://localhost:4800' # TODO: This needs to come from Terraform
      BTWEB_BASE_URL: 'http://localhost:4850' # TODO: This needs to come from Terraform
      BT_COOKIE_NAME: ${self:custom.secrets.cookieName}
      NODE_ENV: production
    logRetentionInDays: 7
    url:
      cors: true
    package:
      patterns:
        - dist/**
        - package.json
    events:
      - httpApi:
          method: ANY
          path: '/{proxy+}'
